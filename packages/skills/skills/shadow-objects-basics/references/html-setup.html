<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Shadow Objects - Complete Setup Example</title>

    <!--
    Shadow Objects HTML Setup Reference
    
    This file demonstrates the complete setup of a Shadow Objects application
    using Web Components: <shae-worker>, <shae-ent>, and <shae-prop>.
  -->

    <!-- Import Shadow Objects Web Components -->
    <script type="module">
      import '@spearwolf/shadow-objects/elements';
    </script>

    <style>
      * {
        box-sizing: border-box;
      }

      body {
        font-family:
          system-ui,
          -apple-system,
          sans-serif;
        max-width: 800px;
        margin: 2rem auto;
        padding: 0 1rem;
        line-height: 1.6;
      }

      h1 {
        color: #333;
      }

      .counter-card {
        background: #f5f5f5;
        border-radius: 8px;
        padding: 1.5rem;
        margin: 1rem 0;
      }

      .counter-display {
        font-size: 3rem;
        font-weight: bold;
        font-family: monospace;
        text-align: center;
        padding: 1rem;
        background: #fff;
        border-radius: 4px;
        margin: 1rem 0;
      }

      .button-group {
        display: flex;
        gap: 0.5rem;
        justify-content: center;
      }

      button {
        padding: 0.75rem 1.5rem;
        font-size: 1rem;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.2s;
      }

      button.primary {
        background: #007bff;
        color: white;
      }

      button.primary:hover {
        background: #0056b3;
      }

      button.secondary {
        background: #6c757d;
        color: white;
      }

      button.secondary:hover {
        background: #545b62;
      }

      button.danger {
        background: #dc3545;
        color: white;
      }

      button.danger:hover {
        background: #c82333;
      }

      .debug-info {
        font-family: monospace;
        font-size: 0.875rem;
        background: #1a1a1a;
        color: #0f0;
        padding: 1rem;
        border-radius: 4px;
        margin-top: 2rem;
      }

      .nested-example {
        border: 2px dashed #ccc;
        padding: 1rem;
        margin: 1rem 0;
        border-radius: 8px;
      }

      .nested-example h3 {
        margin-top: 0;
      }
    </style>
  </head>
  <body>
    <h1>Shadow Objects Setup Example</h1>

    <!--
    ============================================
    STEP 1: Shadow Worker Container
    ============================================
    
    The <shae-worker> element creates the Shadow World context.
    
    Attributes:
    - src: Path to your logic module (exports Registry config)
    - ns: Namespace to connect related components
    - local: (optional) Run on main thread instead of worker
    - auto-sync: (optional) Sync frequency: "frame", "30fps", "100", "no"
  -->
    <shae-worker src="./counter-logic.js" ns="demo-app" auto-sync="frame"> </shae-worker>

    <!--
    ============================================
    STEP 2: Entity with Properties
    ============================================
    
    The <shae-ent> element creates an Entity in the Shadow World.
    
    Attributes:
    - token: Maps to a Registry entry (which Shadow Object to load)
    - ns: Must match the <shae-worker> namespace
    - forward-custom-events: Forward Shadow events as DOM CustomEvents
    
    IMPORTANT: <shae-ent> does NOT need to be a DOM child of <shae-worker>!
    They connect via the namespace (ns) attribute.
  -->
    <section class="counter-card">
      <h2>Counter Example</h2>

      <shae-ent id="counter-entity" token="counter" ns="demo-app" forward-custom-events="count-changed">
        <!--
        ============================================
        STEP 3: Property Bindings
        ============================================
        
        <shae-prop> elements bind View data to Entity properties.
        
        Attributes:
        - name: Property name accessible in Shadow Object
        - value: Initial/current value
        - type: Data type for parsing
        
        Supported types:
        - string (default)
        - number, int (numeric)
        - boolean
        - json (parsed object/array)
        - number[] (comma or space separated)
        - float32array, uint8array, etc.
      -->
        <shae-prop name="count" value="0" type="int"></shae-prop>
        <shae-prop name="step" value="1" type="int"></shae-prop>

        <!-- UI Elements (managed by View, not Shadow) -->
        <div class="counter-display" id="counter-display">0</div>

        <div class="button-group">
          <button class="secondary" id="btn-dec">-1</button>
          <button class="primary" id="btn-inc">+1</button>
          <button class="danger" id="btn-reset">Reset</button>
        </div>
      </shae-ent>
    </section>

    <!--
    ============================================
    NESTED ENTITIES EXAMPLE
    ============================================
    
    Entities can be nested to create parent-child relationships.
    Context provided by parent is available to all descendants.
  -->
    <section class="nested-example">
      <h3>Nested Entities Example</h3>

      <!-- Parent Entity provides context -->
      <shae-ent token="game-state" ns="demo-app">
        <shae-prop name="level" value="1" type="int"></shae-prop>

        <!-- Child Entity consumes parent's context -->
        <shae-ent token="score-display" ns="demo-app">
          <div id="score-output">Score: 0 | Level: 1</div>
        </shae-ent>
      </shae-ent>
    </section>

    <!--
    ============================================
    DEBUG PANEL (Conditional Loading)
    ============================================
    
    This Entity has a 'debug' property. If the Registry has a conditional
    route '@debug', it will only load the debug Shadow Objects when
    debug="true".
  -->
    <section>
      <h3>Debug Mode</h3>
      <label>
        <input type="checkbox" id="debug-toggle" />
        Enable Debug Mode
      </label>

      <shae-ent id="debug-entity" token="app-root" ns="demo-app" forward-custom-events="debug-info">
        <shae-prop name="debug" value="false" type="boolean"></shae-prop>
        <div class="debug-info" id="debug-output" style="display: none">Debug panel will appear here when enabled...</div>
      </shae-ent>
    </section>

    <!--
    ============================================
    VIEW-SIDE JAVASCRIPT
    ============================================
    
    The View layer handles:
    1. User input (button clicks, etc.)
    2. Dispatching events TO the Shadow World
    3. Listening for events FROM the Shadow World
    4. Updating the DOM based on Shadow events
  -->
    <script>
      // Get references to DOM elements
      const counterEntity = document.getElementById('counter-entity');
      const counterDisplay = document.getElementById('counter-display');
      const btnInc = document.getElementById('btn-inc');
      const btnDec = document.getElementById('btn-dec');
      const btnReset = document.getElementById('btn-reset');
      const debugToggle = document.getElementById('debug-toggle');
      const debugEntity = document.getElementById('debug-entity');
      const debugOutput = document.getElementById('debug-output');

      // ============================================
      // SENDING EVENTS TO SHADOW WORLD
      // ============================================

      // Wait for the entity to be connected
      counterEntity.addEventListener('connected', () => {
        console.log('Counter entity connected to Shadow World');
      });

      // Send events to Shadow Object via viewComponent
      btnInc.addEventListener('click', () => {
        // viewComponent is available once entity is connected
        counterEntity.viewComponent?.dispatchShadowObjectsEvent('increment', {
          amount: 1,
        });
      });

      btnDec.addEventListener('click', () => {
        counterEntity.viewComponent?.dispatchShadowObjectsEvent('decrement', {
          amount: 1,
        });
      });

      btnReset.addEventListener('click', () => {
        counterEntity.viewComponent?.dispatchShadowObjectsEvent('reset');
      });

      // ============================================
      // RECEIVING EVENTS FROM SHADOW WORLD
      // ============================================

      // Listen for custom events (enabled by forward-custom-events attribute)
      counterEntity.addEventListener('count-changed', (event) => {
        // event.detail contains the data from Shadow Object
        const {value} = event.detail;
        counterDisplay.textContent = value;

        // Optional: Add visual feedback
        counterDisplay.style.transform = 'scale(1.1)';
        setTimeout(() => {
          counterDisplay.style.transform = 'scale(1)';
        }, 100);
      });

      // ============================================
      // UPDATING PROPERTIES DYNAMICALLY
      // ============================================

      debugToggle.addEventListener('change', (event) => {
        const isDebug = event.target.checked;

        // Find and update the shae-prop element
        const debugProp = debugEntity.querySelector('shae-prop[name="debug"]');
        if (debugProp) {
          debugProp.setAttribute('value', isDebug.toString());
        }

        // Toggle debug output visibility
        debugOutput.style.display = isDebug ? 'block' : 'none';
      });

      // Listen for debug info from Shadow World
      debugEntity.addEventListener('debug-info', (event) => {
        debugOutput.textContent = JSON.stringify(event.detail, null, 2);
      });

      // ============================================
      // ALTERNATIVE: Using @spearwolf/eventize
      // ============================================

      // For more complex event handling, you can use the eventize library:
      //
      // import { on } from '@spearwolf/eventize';
      //
      // on(counterEntity.viewComponent, 'count-changed', (data) => {
      //   console.log('Count changed:', data.value);
      // });
    </script>

    <!--
    ============================================
    COUNTER LOGIC MODULE (counter-logic.js)
    ============================================
    
    Create this file alongside your HTML:
    
    ```javascript
    // counter-logic.js
    
    function Counter({ 
      useProperty, 
      createSignal, 
      createEffect, 
      onViewEvent,
      dispatchMessageToView 
    }) {
      const initialCount = useProperty('count');
      const count = createSignal(initialCount() ?? 0);
      
      createEffect(() => {
        dispatchMessageToView('count-changed', { value: count() });
      });
      
      onViewEvent((type, data) => {
        if (type === 'increment') count.set(c => c + (data?.amount ?? 1));
        if (type === 'decrement') count.set(c => c - (data?.amount ?? 1));
        if (type === 'reset') count.set(0);
      });
    }
    
    function GameState({ createSignal, provideContext }) {
      const score = createSignal(0);
      provideContext('game-score', score);
    }
    
    function ScoreDisplay({ useContext, useProperty, createEffect, dispatchMessageToView }) {
      const score = useContext('game-score');
      const level = useProperty('level');
      
      createEffect(() => {
        dispatchMessageToView('score-update', {
          score: score?.() ?? 0,
          level: level() ?? 1,
        });
      });
    }
    
    export default {
      define: {
        'counter': Counter,
        'game-state': GameState,
        'score-display': ScoreDisplay,
        'app-root': () => {},
      },
    };
    ```
  --></body>
</html>
